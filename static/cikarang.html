<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload File Cikarang</title>
    <!-- Add Bootstrap for styling -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <style>
        /* Style for the drop zone */
        .drop-zone {
            border: 2px dashed #0d6efd; /* Bootstrap primary color */
            border-radius: 8px;
            padding: 50px;
            text-align: center;
            font-size: 1.2rem;
            color: #6c757d; /* Bootstrap secondary text color */
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }

        /* Highlight effect when a file is dragged over */
        .drop-zone.dragover {
            background-color: #e9ecef; /* Light gray background */
            border-color: #0b5ed7; /* Darker blue */
        }

        /* We hide the default file input */
        .drop-zone input[type="file"] {
            display: none;
        }
    </style>
</head>
<body class="d-flex flex-column h-100 text-center bg-body-tertiary">

    <div class="py-2 border-bottom" style="background-color: #121f45;"> 
        <div class="container"> 
            <div class="d-flex flex-wrap align-items-center justify-content-center justify-content-lg-start"> 
                <a href="/" class="d-flex align-items-center my-2 my-lg-0 me-lg-auto text-white text-decoration-none"> 
                    <img src = "/static/assets/honda_logo.png" width="150">
                </a> 

                <ul class="nav col-12 col-lg-auto my-2 justify-content-center my-md-0 text-small"> 
                    <li> 
                        <a href="/" class="nav-link" style="color: white;"> 
                            <i class="bi bi-house-door-fill"></i>
                            Home
                        </a> 
                    </li> 
                </ul> 

                <ul class="nav col-12 col-lg-auto my-2 justify-content-center my-md-0 text-small"> 
                    <li> 
                        <a href="https://personal-site-khaki-six.vercel.app/" class="nav-link" style="color: white;"> 
                            <i class="bi bi-person-circle"></i>
                            Contact
                        </a> 
                    </li> 
                </ul> 

            </div> 
        </div> 
      </div>

      <br>


    <div class="row">
        <div class="col-md-8 offset-md-2">
            <h1 class="mb-4">Upload laporan gaji cabang CIKARANG</h1>
            
            <!-- 
              The form still submits to your FastAPI endpoint as before.
              The JavaScript just helps get the file into the <input>
            -->
            <form action="/upload/cikarang" method="POST" enctype="multipart/form-data" id="uploadForm">
                
                <!-- 
                  This label now acts as the drop zone.
                  Clicking it will trigger the hidden file input.
                -->
                <label for="fileInput" class="drop-zone" id="dropZone">
                    <!-- The file input is hidden via CSS -->
                    <input type="file" name="file" id="fileInput" accept=".xlsx, .xls">
                    
                    <!-- This text will update to show the selected file -->
                    <span id="dropZoneText">Drag & drop atau klik untuk memilih file Excel</span>
                </label>

                <div class="d-grid gap-2 mt-4">
                    <button type="submit" class="btn btn-warning btn-lg" style="color: #223971;">Upload File Excel</button>
                </div>

            </form>
            
            <hr class="my-4">
            
            <a href="/cabang" class="btn btn-primary">&laquo; Kembali ke Pilihan Cabang</a>
        </div>
    </div>


    <script>
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const dropZoneText = document.getElementById('dropZoneText');
        const uploadForm = document.getElementById('uploadForm');
        
        // ... (all your existing drop-zone and fileInput listeners) ...
        
        // vvvvv REPLACE YOUR 'submit' LISTENER WITH THIS vvvvv
        uploadForm.addEventListener('submit', (e) => {
            // 1. Stop the form from submitting normally
            e.preventDefault();

            const uploadButton = uploadForm.querySelector('button[type="submit"]');

            if (fileInput.files.length === 0) {
                alert("Please select a file to upload.");
                return;
            }

            // 2. Show loading spinner
            uploadButton.innerHTML = `
                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                Processing...
            `;
            uploadButton.disabled = true;

            // 3. Create FormData to send the file
            const formData = new FormData(uploadForm);
            
            // 4. Send the file using fetch()
            fetch(uploadForm.action, {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Upload failed. Server responded with ' + response.status);
                }
                return response.json(); // Get the JSON data from the server
            })
            .then(jsonData => {
                // 5. Check if the server returned an error message
                if (jsonData.message || !jsonData.office || !jsonData.driver) {
                    const errorMsg = jsonData.message || 'Error processing file.';
                    throw new Error(errorMsg);
                }
            
                // 6. Save the data to the browser's session storage
                // We must stringify it to store it
                sessionStorage.setItem('reportData', JSON.stringify(jsonData));
                
                // 7. Manually redirect to the report viewer page
                window.location.href = '/report_viewer';
            })
            .catch(error => {
                // Handle any errors
                alert('Error: ' + error.message);
                // Reset the button
                uploadButton.innerHTML = 'Upload File Excel';
                uploadButton.disabled = false;
            });
        });

    </script>
</body>
</html>