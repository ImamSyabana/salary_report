<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laporan Gaji Cikarang</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <style>
        body { 
            font-family: sans-serif; 
            padding: 20px;
        }

    </style>

</head>
<body class = "bg-body-tertiary">

    <div class="py-2 border-bottom" style="background-color: #121f45;"> 
        <div class="container"> 
            <div class="d-flex flex-wrap align-items-center justify-content-center justify-content-lg-start"> 
                <a href="/" class="d-flex align-items-center my-2 my-lg-0 me-lg-auto text-white text-decoration-none"> 
                    <img src = "/static/assets/honda_logo.png" width="150">
                </a> 

                <ul class="nav col-12 col-lg-auto my-2 justify-content-center my-md-0 text-small"> 
                    <li> 
                        <a href="/" class="nav-link" style="color: white;"> 
                            <i class="bi bi-house-door-fill"></i>
                            Home
                        </a> 
                    </li> 
                </ul> 

                <ul class="nav col-12 col-lg-auto my-2 justify-content-center my-md-0 text-small"> 
                    <li> 
                        <a href="https://personal-site-khaki-six.vercel.app/" class="nav-link" style="color: white;"> 
                            <i class="bi bi-person-circle"></i>
                            Contact
                        </a> 
                    </li> 
                </ul> 

            </div> 
        </div> 
      </div>

    <br>

    <h1 class="mb-4 report-title">Laporan Gaji (Admin & Driver)</h1>
    
    <div class="table-responsive">
        <table class="table table-striped table-hover table-bordered">
            <thead class="table-dark">
                <tr>
                    <th>Nama</th>
                    <th>Gaji Pokok</th>
                    <th>Total Uang Makan</th>
                    <th>Insentif Dealer</th>
                    <th>Gaji Total</th>
                    <th>Gaji Diterima</th>
                </tr>
            </thead>
            <tbody id="office-table-body">
                <tr>
                    <td colspan="6" class="text-center">Loading data...</td>
                </tr>
            </tbody>
        </table>
    </div>
    
    <h2 class="mt-5">Data Driver</h2>

    <div class="table-responsive">
        <table class="table table-striped table-hover table-bordered">
            <thead class="table-dark">
                <tr>
                    <th>Nama</th>
                    <th>Gaji Pokok</th>
                    <th>Total Uang Makan</th>
                    <th>Insentif Dealer</th>
                    <th>Gaji Total</th>
                    <th>Gaji Diterima</th>
                </tr>
            </thead>
            <tbody id="driver-table-body">
                <tr>
                    <td colspan="6" class="text-center">Loading data...</td>
                </tr>
            </tbody>
        </table>
    </div>
    
    <hr class="my-5">

    
    <a href="/cabang">
        <button class="btn btn-dark rounded-pill px-3" type="button">
            Cek Laporan Lain
        </button>
    </a><br>
    

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // 1. Get the query string from the URL
        const params = new URLSearchParams(window.location.search);
        // This 'file' parameter matches the one from our RedirectResponse
        const filename = params.get('file');
        const cabang = params.get('nm_cabang');

        
        // 2. Get references to our new table bodies
        const officeTableBody = document.getElementById('office-table-body');
        const driverTableBody = document.getElementById('driver-table-body');
        const titleElement = document.getElementById('report-title');

        // 3. vvvv ADDED THIS BLOCK TO UPDATE TITLE vvvv
        if (cabang) {
            // Capitalize the first letter
            const formattedCabang = cabang.charAt(0).toUpperCase() + cabang.slice(1);
            titleElement.textContent = `Laporan Gaji (Admin & Driver) ${formattedCabang}`;
            document.title = `Laporan ${formattedCabang}`; // Also update browser tab
        }
        
        // 3. Helper function to format numbers as Rupiah
        // This will turn '1500000' into 'Rp 1.500.000'
        function formatRupiah(number) {
            // Handle null, undefined, or 0
            if (!number) {
                return "Rp 0";
            }
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(number);
        }

        // 4. Helper function to populate a table
        function populateTable(tableBody, dataArray) {
            // Clear the "Loading data..." message
            tableBody.innerHTML = '';

            // Check if the array is empty
            if (dataArray.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" class="text-center">No data found.</td></tr>';
                return;
            }

            // Loop through each person in the data array
            dataArray.forEach(person => {
                // Create a new table row
                const row = document.createElement('tr');

                // Add cells (td) for each piece of data
                row.innerHTML = `
                    <td>${person.Nama}</td>
                    <td>${formatRupiah(person.Gaji_pokok)}</td>
                    <td>${formatRupiah(person.UM_Total)}</td>
                    <td>${formatRupiah(person.instv_DLR)}</td>
                    <td>${formatRupiah(person.Gaji_total)}</td>
                    <td>${formatRupiah(person.Gaji_diterima)}</td>
                `;

                // Add the new row to the table body
                tableBody.appendChild(row);
            });
        }

        // 5. Main fetch logic
        if (filename) {
            const fileUrl = `/get-uploaded-file/${filename}`;
            
            fetch(fileUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('File not found or error loading.');
                    }
                    return response.json(); // Parse the response as a JSON object
                })
                .then(jsonData => {
                    // We got the data! Now populate the tables
                    populateTable(officeTableBody, jsonData.office);
                    populateTable(driverTableBody, jsonData.driver);
                })
                .catch(error => {
                    const errorMsg = `Error: ${error.message}`;
                    officeTableBody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">${errorMsg}</td></tr>`;
                    driverTableBody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">${errorMsg}</td></tr>`;
                });
            
        } else {
            const errorMsg = 'Error: No data file specified.';
            officeTableBody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">${errorMsg}</td></tr>`;
            driverTableBody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">${errorMsg}</td></tr>`;
        }
    </script>
</body>
</html>