<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laporan Gaji</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <style>
        body { 
            font-family: sans-serif; 
            padding: 20px;
        }
        .error-container {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 5px;
            padding: 20px;
            margin: 20px 0;
        }
        .loading-spinner {
            display: inline-block;
            width: 2rem;
            height: 2rem;
            vertical-align: text-bottom;
            border: .25em solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            animation: spinner-border .75s linear infinite;
        }
        @keyframes spinner-border {
            to { transform: rotate(360deg); }
        }
    </style>

</head>
<body class="bg-body-tertiary">

    <div class="py-2 border-bottom" style="background-color: #121f45;"> 
        <div class="container"> 
            <div class="d-flex flex-wrap align-items-center justify-content-center justify-content-lg-start"> 
                <a href="/" class="d-flex align-items-center my-2 my-lg-0 me-lg-auto text-white text-decoration-none"> 
                    <img src="/static/assets/honda_logo.png" width="150">
                </a> 

                <ul class="nav col-12 col-lg-auto my-2 justify-content-center my-md-0 text-small"> 
                    <li> 
                        <a href="/" class="nav-link" style="color: white;"> 
                            <i class="bi bi-house-door-fill"></i>
                            Home
                        </a> 
                    </li> 
                </ul> 

                <ul class="nav col-12 col-lg-auto my-2 justify-content-center my-md-0 text-small"> 
                    <li> 
                        <a href="https://personal-site-khaki-six.vercel.app/" class="nav-link" style="color: white;"> 
                            <i class="bi bi-person-circle"></i>
                            Contact
                        </a> 
                    </li> 
                </ul> 

            </div> 
        </div>
    </div>

    <br>

    <div class="container">
        <h1 class="mb-4" id="report-title">Laporan Gaji</h1>
        
        <div id="error-message" class="error-container" style="display: none;">
            <h4><i class="bi bi-exclamation-triangle-fill"></i> Terjadi Kesalahan</h4>
            <p id="error-text"></p>
            <a href="/cabang" class="btn btn-primary mt-3">Kembali dan Upload Ulang</a>
        </div>

        <h2 class="mb-3">Admin</h2>
        <div class="table-responsive">
            <table class="table table-striped table-hover table-bordered">
                <thead class="table-dark">
                    <tr>
                        <th>Nama</th>
                        <th>Gaji Pokok</th>
                        <th>Total Uang Makan</th>
                        <th>Insentif Dealer</th>
                        <th>Gaji Total</th>
                        <th>Gaji Diterima</th>
                    </tr>
                </thead>
                <tbody id="office-table-body">
                    <tr>
                        <td colspan="6" class="text-center">
                            <div class="loading-spinner"></div> Loading data...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <h2 class="mb-3 mt-5">Driver</h2>
        <div class="table-responsive">
            <table class="table table-striped table-hover table-bordered">
                <thead class="table-dark">
                    <tr>
                        <th>Nama</th>
                        <th>Gaji Pokok</th>
                        <th>Total Uang Makan</th>
                        <th>Insentif Dealer</th>
                        <th>Gaji Total</th>
                        <th>Gaji Diterima</th>
                    </tr>
                </thead>
                <tbody id="driver-table-body">
                    <tr>
                        <td colspan="6" class="text-center">
                            <div class="loading-spinner"></div> Loading data...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <hr class="my-5">
        
        <a href="/cabang">
            <button class="btn btn-warning rounded-pill px-3" type="button" style="color: #223971;">
                Cek Laporan Lain
            </button>
        </a>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const params = new URLSearchParams(window.location.search);
        const filename = params.get('file');
        const cabang = params.get('nm_cabang');

        const officeTableBody = document.getElementById('office-table-body');
        const driverTableBody = document.getElementById('driver-table-body');
        const titleElement = document.getElementById('report-title');
        const errorContainer = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');

        // Update title
        if (cabang) {
            const formattedCabang = cabang.charAt(0).toUpperCase() + cabang.slice(1);
            titleElement.textContent = `Laporan Gaji ${formattedCabang}`;
            document.title = `Laporan ${formattedCabang}`;
        }

        function showError(message) {
            console.error('Error:', message);
            errorText.textContent = message;
            errorContainer.style.display = 'block';
            officeTableBody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Gagal memuat data</td></tr>';
            driverTableBody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Gagal memuat data</td></tr>';
        }

        function formatRupiah(number) {
            if (!number && number !== 0) {
                return "Rp 0";
            }
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(number);
        }

        function populateTable(tableBody, dataArray) {
            tableBody.innerHTML = '';

            if (!dataArray || dataArray.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" class="text-center">Tidak ada data</td></tr>';
                return;
            }

            dataArray.forEach(person => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${person.Nama || 'N/A'}</td>
                    <td>${formatRupiah(person.Gaji_pokok)}</td>
                    <td>${formatRupiah(person.UM_Total)}</td>
                    <td>${formatRupiah(person.instv_DLR)}</td>
                    <td>${formatRupiah(person.Gaji_total)}</td>
                    <td>${formatRupiah(person.Gaji_diterima)}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Main fetch logic
        if (!filename) {
            showError('Parameter file tidak ditemukan di URL. Silakan upload file kembali.');
        } else {
            const fileUrl = `/get-uploaded-file/${filename}`;
            
            console.log('Fetching from:', fileUrl);
            
            fetch(fileUrl)
                .then(response => {
                    console.log('Response status:', response.status);
                    
                    if (!response.ok) {
                        return response.json().then(errData => {
                            throw new Error(errData.detail || `HTTP ${response.status}: ${response.statusText}`);
                        }).catch(() => {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        });
                    }
                    return response.json();
                })
                .then(jsonData => {
                    console.log('Data received:', jsonData);
                    
                    // Validasi struktur data
                    if (!jsonData || typeof jsonData !== 'object') {
                        throw new Error('Data yang diterima bukan objek JSON yang valid');
                    }
                    
                    if (!jsonData.office || !jsonData.driver) {
                        throw new Error('Struktur data tidak lengkap (office atau driver tidak ditemukan)');
                    }
                    
                    if (!Array.isArray(jsonData.office) || !Array.isArray(jsonData.driver)) {
                        throw new Error('Data office atau driver bukan array');
                    }
                    
                    // Populate tables
                    populateTable(officeTableBody, jsonData.office);
                    populateTable(driverTableBody, jsonData.driver);
                })
                .catch(error => {
                    showError(`${error.message}. Silakan upload file kembali.`);
                });
        }
    </script>
</body>
</html>